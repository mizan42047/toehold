import { registerPlugin } from '@wordpress/plugins';
import { PluginSidebar } from '@wordpress/edit-post';
import { PanelBody } from '@wordpress/components';
import AsyncSelect from 'react-select/async';
import apifetch from '@wordpress/api-fetch';
import { addQueryArgs } from '@wordpress/url';
import { useEntityProp } from '@wordpress/core-data';
import { useSelect } from '@wordpress/data';

const ToeholdSidebar = () => {
    const postType = useSelect(
        ( select ) => select( 'core/editor' ).getCurrentPostType(),
        []
    );

    const [ meta, setMeta ] = useEntityProp( 'postType', postType, 'meta' );
    const loadPosts = (input) => {
        const queryParams = { search: input };
        const request = apifetch({
            path: addQueryArgs('/wp/v2/search', queryParams),
        }).then((result) => {
            if (result && result.length > 0) {
                const options = result.map((post) => {
                    return { value: post.id, label: post.title }
                })
                return options;
            }
        }).catch((error) => {
            console.error(error);
        })

        return request;
    }

    console.log(meta);

    return (
        <>
            <PluginSidebar name="toehold-sidebar" title="Toehold">
                <PanelBody title='Custom Breadcrumbs'>
                    <AsyncSelect
                        cacheOptions
                        defaultOptions
                        isClearable
                        isMulti
                        loadOptions={loadPosts}
                        value={meta.toehold_custom_breadcrumbs}
                        onChange={(value) => setMeta({ ...meta, toehold_custom_breadcrumbs: value })}
                    />
                </PanelBody>
            </PluginSidebar>
        </>
    )
}

registerPlugin('toehold-sidebar', {
    icon: <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 40 40">
        <path fill="#000" d="M39.63.21H0v39.15h39.63V.21Z" />
        <path fill="#fff" d="M28.026 18.486a.44.44 0 0 0 .432.384c.624-.024 2.4.816 2.064.096-.312-.624-.168-1.56-.048-1.992.168-.624-1.296.312-2.232.384-.072.12-.144.24-.192.384a1.136 1.136 0 0 0-.024.744Z" />
        <path fill="#fff" d="M27.978 17.358c-.672.048-1.464-.048-2.256-.048v-.36h-.462l.072-.384a.692.692 0 0 0-.432-.528c-.072-.024-.12-.024-.192-.048l-.096-.024-.456-.288-.384-.12v.384l-.408-.024c-.024.048-.048.072-.096.12-.264.408-.48.72-.624.96a.973.973 0 0 0-.12.216c0 .456-.024.672-.024.648.024.048.024.072-.024.096-.048.024-.096.144-.168.336-.048.144-.12.288-.192.432-.072.096-.144.216-.264.336-.12.144-.264.288-.408.408a.432.432 0 0 1-.528 0c-.888-.408-1.464-.696-1.752-.816-.216-.12-.456-.192-.696-.264-.168-.048-.288-.144-.288-.264a1.992 1.992 0 0 0-.144-.504 1.403 1.403 0 0 1-.096-.456c0-.048 0-.12.024-.168l.144-.24c.096-.192.168-.408.168-.624v-.072a2.274 2.274 0 0 0-.168-.696c.12-.144.24-.288.408-.384.192-.12.408-.192.624-.216.24.024.456.144.624.336.216.192.432.36.672.528.12.072.264.144.384.192.192.072.36.096.552.12.336 0 .672-.072.984-.216.192-.072.336-.12.432-.168 0 0 .024-.048.144-.144.048-.096.12-.24.192-.36.048-.096.12-.216.192-.408.072-.144.12-.288.168-.432a3.616 3.616 0 0 0 .072-1.752v-.024c.192-.048.384-.144.552-.216.768-.384 1.416-.984 1.8-1.752-.024-.624-.36-.912-1.032-.888-.528.6-1.2 1.032-1.944 1.248v-.03c.072-.048.072-.072-.024-.096L22.02 7.89c-.216-.312-.6-.24-1.224.168-.816-.432-1.416-.36-1.824.24l-.024 2.862a.257.257 0 0 1-.336.024 5.3 5.3 0 0 1-1.008-1.392c-.984-.312-1.464.048-1.416 1.08a3.873 3.873 0 0 0 1.536 1.32.79.79 0 0 1-.696.024c.072.072.144.144.192.216.12.144.288.24.48.264.168 0 .264 0 .264.024.024.048.048.072.096.12a.146.146 0 0 1 0 .192.899.899 0 0 1-.312.288c-.24.168-.384.264-.432.288-.048.024-.144.168-.312.36l-.144.144a.523.523 0 0 1-.192.12c-.144.024-.288.024-.408-.048a.639.639 0 0 0-.288-.072v-.024c-.048 0-.096 0-.168.024a1.253 1.253 0 0 0-.456.336v.048c-.048.024-.072.072-.096.12-.12.144-.288.336-.504.576a17.96 17.96 0 0 0-.672 1.56c.096-.264.192-.528.264-.768v.024c.096-.264.168-.552.216-.84l-.12-1.632c-.192-.264-.528-.384-.984-.336-1.44.12-2.568.96-3.366 2.544-.072.12-.144.264-.192.408-.672 1.416-1.08 2.664-1.176 3.75-.12.96-.096 1.92.072 2.862.168.744.816 1.296 1.944 1.68 1.128.384 1.8-.36 2.016-2.184.048 1.512.288 3.006.72 4.446h.024c1.896-.12 3.006-.816 3.366-2.112 0-.024.024-.024.024-.048a2.945 2.945 0 0 1-.288-.624c-.024-.096-.048-.216-.096-.384a23.13 23.13 0 0 1-.168-1.656v-.024c0-.144-.024-.264-.024-.36v-.096c0-.072-.024-.168-.024-.24 0-.072.096-1.128.168-1.824.24.048.768.576.84.624.864.864 1.512 1.392 1.968 1.536.024 0 .072.024.096.024.456.12.48.12.072.048h.048c.216.048.432.072.648.072a.652.652 0 0 0 .408-.144c0-.024.024-.024.024-.024.072-.096.336-.384.744-.84.36.144.744.264 1.128.336 1.968-.528 2.982-.792 3.03-.768.048.024.528-.216 1.416-.768.12-.072.072-.192-.144-.336h-.048.048s-.024 0-.024-.024c.024 0 .048 0 .072.024-.096-.048.768-.144 1.176-.168-.408-.612-.216-1.188.024-1.572Zm-5.838-4.422a.483.483 0 0 1 .12.528.471.471 0 0 1-.216.312.393.393 0 0 1-.288.048c-.096-.024-.168-.096-.168-.168-.024-.096.024-.192.168-.288.144-.096.12-.168-.048-.216-.168-.048-.168-.144-.024-.288.12-.12.288-.096.408 0 0 .024.024.048.048.072Zm1.44 6.63c.552-.048.48.048-.264.312-.168.048-.48.144-.936.264h-.12l-.288-.096c.096-.048.168-.096.24-.144.192-.168.384-.336.528-.552.288.12.552.192.84.216Zm-4.374.432 1.104.288c.024 0 .072.024.096.024 0 .048-.048.096-.168.168a.78.78 0 0 0-.312.24 2.323 2.323 0 0 1-.744-.432 2.055 2.055 0 0 1-.456-.456c.048.024.072.048.12.048.12.048.24.072.36.12Z" />
        <path fill="#fff" d="M15.408 30.33c.168.192.336.408.48.648.36.48.768.888 1.248 1.272.072 0 .144 0 .192-.024.048-.024.12-.024.168-.024a.981.981 0 0 1 .552.432 1.1 1.1 0 0 1 .36.6c-.048.24-.168.48-.36.624-.144.144-.336.312-.576.528a3.282 3.282 0 0 0-.432.576.619.619 0 0 0-.024.672c.096.144.48.24 1.104.264h1.296c.24.024.504 0 .744-.024.288-.072.408-.216.36-.456-.024-.144-.144-.264-.312-.312a2.563 2.563 0 0 0-.6-.072c-.216 0-.408-.024-.624-.072a.5.5 0 0 1-.384-.264c.072-.168.168-.336.312-.456l.432-.36a.946.946 0 0 0 .336-1.056 1.217 1.217 0 0 0-.216-.384c-.144-.168-.24-.288-.312-.36-.144-.168-.24-.312-.312-.384-.096-.096-.144-.216-.192-.336a.78.78 0 0 1 .24-.432l.384-.408a7.309 7.309 0 0 1 .432-.456 1.54 1.54 0 0 1 .312-.24c.12-.048.24-.096.36-.12l.408-.12c.12-.048.264-.096.408-.144a.773.773 0 0 1 .408-.024c.12.048.192.264.24.648.024.168.048.312.048.48.024.36.048.624.072.744 0 .168.072.336.192.48.144.144.432.192.84.144.288-.024.576-.072.864-.168.336-.072.672-.216.984-.384.288-.168.432-.528.312-.84a1.79 1.79 0 0 0-.624-.096c-.192.024-.408.048-.6.12-.144.072-.312.144-.456.216-.144.096-.312.12-.48.12-.168-.024-.264-.168-.312-.432-.024-.12-.024-.24-.024-.36V28.746c-.024-.288-.096-.48-.192-.552a.765.765 0 0 0-.72 0c-.24.096-.504.144-.768.168a.337.337 0 0 1-.048-.336c.024-.12 0-.24-.024-.36a6.65 6.65 0 0 1-2.184-.984 5.69 5.69 0 0 1-1.464-1.656c-.048-.096-.072-.168-.096-.216-.408 1.32-1.56 2.064-3.51 2.16a9.5 9.5 0 0 0 1.272 2.568c.102.264.294.528.486.792Z" />
    </svg>,
    render: ToeholdSidebar,
});
